<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Identity Registry</title>
  <style>
    body { font-family: sans-serif; margin: auto; }
    #msg { white-space: pre-wrap; }
    #connect-btn, #disconnect-btn {
      margin: 5px;
    }
    .actions {
      margin-top: 20px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-width: 780px;
    }
    .actions h4 {
      margin: 0 0 10px;
    }
    .actions h5 {
      margin: 16px 0 8px;
      color: #333;
    }
    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    .action-row input,
    .action-row select {
      padding: 6px 8px;
      min-width: 180px;
    }
    .action-row button {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h3 id="page-title">Identity Registry</h3>
  <button id="connect-btn">Connect Wallet</button>
  <button id="disconnect-btn" style="display:none;">Disconnect</button>
  <section class="actions">
    <h4>Identity Registry Actions</h4>
    <h5>Write Actions</h5>
    <div class="action-row">
      <strong>Add Participant</strong>
      <input id="add-account" placeholder="Account address" />
      <input id="add-role" placeholder="Role (bytes32 or label)" />
      <input id="add-expiry" placeholder="KYC expiry (unix timestamp)" />
      <button id="add-participant-btn" disabled>Add</button>
    </div>
    <div class="action-row">
      <strong>Change Role</strong>
      <input id="change-account" placeholder="Account address" />
      <input id="change-role" placeholder="New role (bytes32 or label)" />
      <button id="change-role-btn" disabled>Change</button>
    </div>
    <div class="action-row">
      <strong>Renew KYC</strong>
      <input id="renew-account" placeholder="Account address" />
      <input id="renew-expiry" placeholder="New expiry (unix timestamp)" />
      <button id="renew-kyc-btn" disabled>Renew</button>
    </div>
    <div class="action-row">
      <strong>Remove Participant</strong>
      <input id="remove-account" placeholder="Account address" />
      <button id="remove-participant-btn" disabled>Remove</button>
    </div>
    <div class="action-row">
      <strong>Freeze Participant</strong>
      <input id="freeze-account" placeholder="Account address" />
      <input id="freeze-reason" placeholder="Reason" />
      <button id="freeze-btn" disabled>Freeze</button>
      <button id="unfreeze-btn" disabled>Unfreeze</button>
    </div>
    <div class="action-row">
      <strong>Pause Controls</strong>
      <button id="pause-btn" disabled>Pause</button>
      <button id="unpause-btn" disabled>Unpause</button>
    </div>
    <div class="action-row">
      <strong>Precompile Sync</strong>
      <select id="precompile-enabled">
        <option value="true">Enable</option>
        <option value="false">Disable</option>
      </select>
      <button id="precompile-btn" disabled>Set</button>
    </div>
    <div class="action-row">
      <strong>Lookup Participant</strong>
      <input id="lookup-account" placeholder="Account address" />
      <button id="lookup-btn" disabled>Lookup</button>
    </div>
    <h5>Read Actions</h5>
    <div class="action-row">
      <strong>Current Role</strong>
      <input id="current-role-account" placeholder="Account address" />
      <button id="current-role-btn" disabled>Get Role</button>
    </div>
    <div class="action-row">
      <strong>Check Role</strong>
      <input id="check-role-account" placeholder="Account address" />
      <input id="check-role-value" placeholder="Role (bytes32 or label)" />
      <button id="check-role-btn" disabled>Check</button>
    </div>
    <div class="action-row">
      <strong>Allowed To Transact</strong>
      <input id="allowed-account" placeholder="Account address" />
      <button id="allowed-btn" disabled>Check</button>
    </div>
    <div class="action-row">
      <strong>Participant State</strong>
      <input id="state-account" placeholder="Account address" />
      <button id="state-btn" disabled>Get State</button>
    </div>
    <div class="action-row">
      <strong>Participants List</strong>
      <input id="participants-offset" placeholder="Offset" />
      <input id="participants-limit" placeholder="Limit" />
      <button id="participants-btn" disabled>Fetch</button>
    </div>
  </section>
  <pre id="msg"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script>
    // === CONFIGURATION ===
    const FALAJ_NETWORK = {
      chainId: 75417,
      chainName: 'Falaj Testnet',
      rpcUrls: ['https://nodes-prod.18.182.4.86.sslip.io/ext/bc/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB/rpc'],
      nativeCurrency: { name: 'E-AED', symbol: 'E-AED', decimals: 18 },
      blockExplorerUrls: ['https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB']
    };

    const EXPLORER_BASE = 'https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB';

    const IDENTITY_REGISTRY_ADDRESS = '0x189c4B40C5d073231e8fcd65370F55B55f25321c';
    const IDENTITY_REGISTRY_ABI = [
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "uint256",
            "name": "_kycExpiry",
            "type": "uint256"
          }
        ],
        "name": "addParticipant",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "newRole",
            "type": "bytes32"
          }
        ],
        "name": "changeRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "reason",
            "type": "string"
          }
        ],
        "name": "freezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "removeParticipant",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "newExpiry",
            "type": "uint256"
          }
        ],
        "name": "renewKYC",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "pause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bool",
            "name": "enabled",
            "type": "bool"
          }
        ],
        "name": "setPrecompileSync",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "unfreezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "unpause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "getParticipant",
        "outputs": [
          {
            "internalType": "bool",
            "name": "whitelisted",
            "type": "bool"
          },
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "uint256",
            "name": "expiry",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "frozen",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "isAllowedToTransact",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          }
        ],
        "name": "hasParticipantRole",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "offset",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "limit",
            "type": "uint256"
          }
        ],
        "name": "getParticipants",
        "outputs": [
          {
            "internalType": "address[]",
            "name": "addresses",
            "type": "address[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "participantCount",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "participantRole",
        "outputs": [
          {
            "internalType": "bytes32",
            "name": "",
            "type": "bytes32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "isWhitelisted",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "isFrozen",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "kycExpiry",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "precompileSyncEnabled",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // === STATE ===
    let provider = null;
    let signer = null;
    let registry = null;

    // === UI UTILS ===
    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    function setActionButtonsEnabled(enabled) {
      const actionButtons = [
        'add-participant-btn',
        'change-role-btn',
        'renew-kyc-btn',
        'remove-participant-btn',
        'freeze-btn',
        'unfreeze-btn',
        'pause-btn',
        'unpause-btn',
        'precompile-btn',
        'lookup-btn',
        'current-role-btn',
        'check-role-btn',
        'allowed-btn',
        'state-btn',
        'participants-btn'
      ];
      actionButtons.forEach((id) => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !enabled;
      });
    }

    function requireValue(value, label) {
      if (!value) {
        throw new Error(`${label} is required.`);
      }
      return value;
    }

    function parseExpiry(value) {
      const sanitized = requireValue(value, 'Expiry timestamp');
      const parsed = Number(sanitized);
      if (!Number.isFinite(parsed) || parsed <= 0) {
        throw new Error('Expiry timestamp must be a positive number.');
      }
      return BigInt(Math.trunc(parsed));
    }

    function parseRole(value) {
      const sanitized = requireValue(value, 'Role');
      if (sanitized.startsWith('0x') && sanitized.length === 66) {
        return sanitized;
      }
      return ethers.id(sanitized);
    }

    const ROLE_LABELS = [
      'REGULATOR',
      'ISSUER_STABLECOIN',
      'ISSUER_BOND',
      'CUSTODIAN',
      'PARTICIPANT'
    ];

    const ROLE_HASHES = ROLE_LABELS.reduce((acc, label) => {
      acc[label] = ethers.id(label);
      return acc;
    }, {});

    function formatRole(roleHash) {
      const match = Object.entries(ROLE_HASHES).find(([, hash]) => hash.toLowerCase() === roleHash.toLowerCase());
      return match ? `${match[0]} (${roleHash})` : roleHash;
    }

    function formatExpiry(expiry) {
      const expiryNumber = Number(expiry);
      if (!Number.isFinite(expiryNumber) || expiryNumber <= 0) {
        return `${expiry}`;
      }
      const date = new Date(expiryNumber * 1000);
      return `${expiry} (${date.toISOString()})`;
    }

    function parsePagination(value, label) {
      const sanitized = requireValue(value, label);
      const parsed = Number(sanitized);
      if (!Number.isFinite(parsed) || parsed < 0) {
        throw new Error(`${label} must be a non-negative number.`);
      }
      return BigInt(Math.trunc(parsed));
    }

    // === WALLET CONNECTION LOGIC ===
    async function setupWallet(kind) {
      if (kind === 'metamask' && window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        registry = new ethers.Contract(IDENTITY_REGISTRY_ADDRESS, IDENTITY_REGISTRY_ABI, signer);
        return;
      }
      throw new Error('MetaMask not found');
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      registry = null;
      setActionButtonsEnabled(false);
      document.getElementById('disconnect-btn').style.display = 'none';
      show('Wallet disconnected');
    }

    // === NETWORK SWITCHING ===
    async function switchNetwork() {
      if (!window.ethereum) {
        throw new Error('MetaMask not found');
      }
      const hex = ethers.toQuantity(FALAJ_NETWORK.chainId);
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: hex }]
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: hex, ...FALAJ_NETWORK }]
          });
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          });
        } else {
          throw err;
        }
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      registry = new ethers.Contract(IDENTITY_REGISTRY_ADDRESS, IDENTITY_REGISTRY_ABI, signer);
    }

    async function ensureCorrectNetwork() {
      if (!provider) throw new Error('No wallet/provider connected');
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== Number(FALAJ_NETWORK.chainId)) {
        throw new Error(`Your wallet is on the wrong network. Please switch to ${FALAJ_NETWORK.chainName} (${FALAJ_NETWORK.chainId}).`);
      }
    }

    // === MAIN UI HANDLING ===
    document.addEventListener('DOMContentLoaded', async () => {
      setActionButtonsEnabled(false);

      // Connect Wallet
      document.getElementById('connect-btn').onclick = async () => {
        show('Connecting...');
        try {
          await setupWallet('metamask');
          await switchNetwork();
          await ensureCorrectNetwork();
          document.getElementById('disconnect-btn').style.display = '';
          document.getElementById('disconnect-btn').onclick = disconnectWallet;
          const address = await signer.getAddress();
          show(`Wallet connected to ${FALAJ_NETWORK.chainName}\nAddress: ${address}`);
          setActionButtonsEnabled(true);
        } catch (err) {
          show('Connection or network switch failed:\n' + (err.message || err));
          disconnectWallet();
        }
      };

      document.getElementById('add-participant-btn').onclick = async () => {
        try {
          show('Adding participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('add-account').value.trim(), 'Account address');
          const role = parseRole(document.getElementById('add-role').value.trim());
          const expiry = parseExpiry(document.getElementById('add-expiry').value.trim());
          const tx = await registry.addParticipant(account, role, expiry);
          const receipt = await tx.wait();
          show(`✅ Participant added\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Add participant failed:\n' + (err.message || err));
        }
      };

      document.getElementById('change-role-btn').onclick = async () => {
        try {
          show('Changing role...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('change-account').value.trim(), 'Account address');
          const role = parseRole(document.getElementById('change-role').value.trim());
          const tx = await registry.changeRole(account, role);
          const receipt = await tx.wait();
          show(`✅ Role changed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Change role failed:\n' + (err.message || err));
        }
      };

      document.getElementById('renew-kyc-btn').onclick = async () => {
        try {
          show('Renewing KYC...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('renew-account').value.trim(), 'Account address');
          const expiry = parseExpiry(document.getElementById('renew-expiry').value.trim());
          const tx = await registry.renewKYC(account, expiry);
          const receipt = await tx.wait();
          show(`✅ KYC renewed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Renew KYC failed:\n' + (err.message || err));
        }
      };

      document.getElementById('remove-participant-btn').onclick = async () => {
        try {
          show('Removing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('remove-account').value.trim(), 'Account address');
          const tx = await registry.removeParticipant(account);
          const receipt = await tx.wait();
          show(`✅ Participant removed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Remove participant failed:\n' + (err.message || err));
        }
      };

      document.getElementById('freeze-btn').onclick = async () => {
        try {
          show('Freezing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const reason = requireValue(document.getElementById('freeze-reason').value.trim(), 'Reason');
          const tx = await registry.freezeAccount(account, reason);
          const receipt = await tx.wait();
          show(`✅ Participant frozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Freeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unfreeze-btn').onclick = async () => {
        try {
          show('Unfreezing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const tx = await registry.unfreezeAccount(account);
          const receipt = await tx.wait();
          show(`✅ Participant unfrozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unfreeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('pause-btn').onclick = async () => {
        try {
          show('Pausing registry...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await registry.pause();
          const receipt = await tx.wait();
          show(`✅ Registry paused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Pause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unpause-btn').onclick = async () => {
        try {
          show('Unpausing registry...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await registry.unpause();
          const receipt = await tx.wait();
          show(`✅ Registry unpaused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unpause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('precompile-btn').onclick = async () => {
        try {
          show('Updating precompile sync...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const enabled = document.getElementById('precompile-enabled').value === 'true';
          const tx = await registry.setPrecompileSync(enabled);
          const receipt = await tx.wait();
          show(`✅ Precompile sync updated (${enabled ? 'enabled' : 'disabled'})\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Precompile sync update failed:\n' + (err.message || err));
        }
      };

      document.getElementById('lookup-btn').onclick = async () => {
        try {
          show('Fetching participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('lookup-account').value.trim(), 'Account address');
          const participant = await registry.getParticipant(account);
          show(
            `Participant details for ${account}\n`
            + `Whitelisted: ${participant[0]}\n`
            + `Role: ${formatRole(participant[1])}\n`
            + `KYC expiry: ${formatExpiry(participant[2])}\n`
            + `Frozen: ${participant[3]}`
          );
        } catch (err) {
          show('Lookup failed:\n' + (err.message || err));
        }
      };

      document.getElementById('current-role-btn').onclick = async () => {
        try {
          show('Fetching current role...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('current-role-account').value.trim(), 'Account address');
          const role = await registry.participantRole(account);
          show(`Current role for ${account}\nRole: ${formatRole(role)}`);
        } catch (err) {
          show('Current role lookup failed:\n' + (err.message || err));
        }
      };

      document.getElementById('check-role-btn').onclick = async () => {
        try {
          show('Checking role...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('check-role-account').value.trim(), 'Account address');
          const roleValue = parseRole(document.getElementById('check-role-value').value.trim());
          const hasRole = await registry.hasParticipantRole(account, roleValue);
          show(`Role check for ${account}\nRole: ${formatRole(roleValue)}\nHas role: ${hasRole}`);
        } catch (err) {
          show('Role check failed:\n' + (err.message || err));
        }
      };

      document.getElementById('allowed-btn').onclick = async () => {
        try {
          show('Checking allowlist...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('allowed-account').value.trim(), 'Account address');
          const allowed = await registry.isAllowedToTransact(account);
          show(`Allowed to transact for ${account}\nAllowed: ${allowed}`);
        } catch (err) {
          show('Allowlist check failed:\n' + (err.message || err));
        }
      };

      document.getElementById('state-btn').onclick = async () => {
        try {
          show('Fetching participant state...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('state-account').value.trim(), 'Account address');
          const [whitelisted, role, expiry, frozen, allowed] = await Promise.all([
            registry.isWhitelisted(account),
            registry.participantRole(account),
            registry.kycExpiry(account),
            registry.isFrozen(account),
            registry.isAllowedToTransact(account)
          ]);
          const syncEnabled = await registry.precompileSyncEnabled();
          show(
            `Participant state for ${account}\n`
            + `Whitelisted: ${whitelisted}\n`
            + `Role: ${formatRole(role)}\n`
            + `KYC expiry: ${formatExpiry(expiry)}\n`
            + `Frozen: ${frozen}\n`
            + `Allowed to transact: ${allowed}\n`
            + `Precompile sync enabled: ${syncEnabled}`
          );
        } catch (err) {
          show('Participant state failed:\n' + (err.message || err));
        }
      };

      document.getElementById('participants-btn').onclick = async () => {
        try {
          show('Fetching participants...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const offset = parsePagination(document.getElementById('participants-offset').value.trim(), 'Offset');
          const limit = parsePagination(document.getElementById('participants-limit').value.trim(), 'Limit');
          const [participants, total] = await Promise.all([
            registry.getParticipants(offset, limit),
            registry.participantCount()
          ]);
          const formatted = participants.length ? participants.join('\n') : 'No participants found for this range.';
          show(
            `Participants (${offset} - ${offset + limit - 1n})\n`
            + `Total registered: ${total}\n`
            + `${formatted}`
          );
        } catch (err) {
          show('Participants fetch failed:\n' + (err.message || err));
        }
      };

      // Disconnect
      document.getElementById('disconnect-btn').onclick = disconnectWallet;
    });
  </script>
</body>
</html>
