<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Identity Registry</title>
  <style>
    body { font-family: sans-serif; margin: auto; }
    #msg { white-space: pre-wrap; }
    #connect-btn, #disconnect-btn {
      margin: 5px;
    }
    .actions {
      margin-top: 20px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-width: 780px;
    }
    .actions h4 {
      margin: 0 0 10px;
    }
    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    .action-row input,
    .action-row select {
      padding: 6px 8px;
      min-width: 180px;
    }
    .action-row button {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h3 id="page-title">Identity Registry</h3>
  <button id="connect-btn">Connect Wallet</button>
  <button id="disconnect-btn" style="display:none;">Disconnect</button>
  <section class="actions">
    <h4>Identity Registry Actions</h4>
    <div class="action-row">
      <strong>Add Participant</strong>
      <input id="add-account" placeholder="Account address" />
      <input id="add-role" placeholder="Role (bytes32 or label)" />
      <input id="add-expiry" placeholder="KYC expiry (unix timestamp)" />
      <button id="add-participant-btn" disabled>Add</button>
    </div>
    <div class="action-row">
      <strong>Change Role</strong>
      <input id="change-account" placeholder="Account address" />
      <input id="change-role" placeholder="New role (bytes32 or label)" />
      <button id="change-role-btn" disabled>Change</button>
    </div>
    <div class="action-row">
      <strong>Renew KYC</strong>
      <input id="renew-account" placeholder="Account address" />
      <input id="renew-expiry" placeholder="New expiry (unix timestamp)" />
      <button id="renew-kyc-btn" disabled>Renew</button>
    </div>
    <div class="action-row">
      <strong>Remove Participant</strong>
      <input id="remove-account" placeholder="Account address" />
      <button id="remove-participant-btn" disabled>Remove</button>
    </div>
    <div class="action-row">
      <strong>Freeze Participant</strong>
      <input id="freeze-account" placeholder="Account address" />
      <input id="freeze-reason" placeholder="Reason" />
      <button id="freeze-btn" disabled>Freeze</button>
      <button id="unfreeze-btn" disabled>Unfreeze</button>
    </div>
    <div class="action-row">
      <strong>Pause Controls</strong>
      <button id="pause-btn" disabled>Pause</button>
      <button id="unpause-btn" disabled>Unpause</button>
    </div>
    <div class="action-row">
      <strong>Precompile Sync</strong>
      <select id="precompile-enabled">
        <option value="true">Enable</option>
        <option value="false">Disable</option>
      </select>
      <button id="precompile-btn" disabled>Set</button>
    </div>
    <div class="action-row">
      <strong>Lookup Participant</strong>
      <input id="lookup-account" placeholder="Account address" />
      <button id="lookup-btn" disabled>Lookup</button>
    </div>
  </section>
  <pre id="msg"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script>
    // === CONFIGURATION ===
    const FALAJ_NETWORK = {
      chainId: 75417,
      chainName: 'Falaj Testnet',
      rpcUrls: ['https://nodes-prod.18.182.4.86.sslip.io/ext/bc/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB/rpc'],
      nativeCurrency: { name: 'E-AED', symbol: 'E-AED', decimals: 18 },
      blockExplorerUrls: ['https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB']
    };

    const EXPLORER_BASE = 'https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB';

    const IDENTITY_REGISTRY_ADDRESS = '0x189c4B40C5d073231e8fcd65370F55B55f25321c';
    const IDENTITY_REGISTRY_ABI = [
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "uint256",
            "name": "_kycExpiry",
            "type": "uint256"
          }
        ],
        "name": "addParticipant",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "newRole",
            "type": "bytes32"
          }
        ],
        "name": "changeRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "reason",
            "type": "string"
          }
        ],
        "name": "freezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "removeParticipant",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "newExpiry",
            "type": "uint256"
          }
        ],
        "name": "renewKYC",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "pause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bool",
            "name": "enabled",
            "type": "bool"
          }
        ],
        "name": "setPrecompileSync",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "unfreezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "unpause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "getParticipant",
        "outputs": [
          {
            "internalType": "bool",
            "name": "whitelisted",
            "type": "bool"
          },
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "uint256",
            "name": "expiry",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "frozen",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // === STATE ===
    let provider = null;
    let signer = null;
    let registry = null;

    // === UI UTILS ===
    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    function setActionButtonsEnabled(enabled) {
      const actionButtons = [
        'add-participant-btn',
        'change-role-btn',
        'renew-kyc-btn',
        'remove-participant-btn',
        'freeze-btn',
        'unfreeze-btn',
        'pause-btn',
        'unpause-btn',
        'precompile-btn',
        'lookup-btn'
      ];
      actionButtons.forEach((id) => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !enabled;
      });
    }

    function requireValue(value, label) {
      if (!value) {
        throw new Error(`${label} is required.`);
      }
      return value;
    }

    function parseExpiry(value) {
      const sanitized = requireValue(value, 'Expiry timestamp');
      const parsed = Number(sanitized);
      if (!Number.isFinite(parsed) || parsed <= 0) {
        throw new Error('Expiry timestamp must be a positive number.');
      }
      return BigInt(Math.trunc(parsed));
    }

    function parseRole(value) {
      const sanitized = requireValue(value, 'Role');
      if (sanitized.startsWith('0x') && sanitized.length === 66) {
        return sanitized;
      }
      return ethers.id(sanitized);
    }

    // === WALLET CONNECTION LOGIC ===
    async function setupWallet(kind) {
      if (kind === 'metamask' && window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        registry = new ethers.Contract(IDENTITY_REGISTRY_ADDRESS, IDENTITY_REGISTRY_ABI, signer);
        return;
      }
      throw new Error('MetaMask not found');
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      registry = null;
      setActionButtonsEnabled(false);
      document.getElementById('disconnect-btn').style.display = 'none';
      show('Wallet disconnected');
    }

    // === NETWORK SWITCHING ===
    async function switchNetwork() {
      if (!window.ethereum) {
        throw new Error('MetaMask not found');
      }
      const hex = ethers.toQuantity(FALAJ_NETWORK.chainId);
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: hex }]
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: hex, ...FALAJ_NETWORK }]
          });
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          });
        } else {
          throw err;
        }
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      registry = new ethers.Contract(IDENTITY_REGISTRY_ADDRESS, IDENTITY_REGISTRY_ABI, signer);
    }

    async function ensureCorrectNetwork() {
      if (!provider) throw new Error('No wallet/provider connected');
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== Number(FALAJ_NETWORK.chainId)) {
        throw new Error(`Your wallet is on the wrong network. Please switch to ${FALAJ_NETWORK.chainName} (${FALAJ_NETWORK.chainId}).`);
      }
    }

    // === MAIN UI HANDLING ===
    document.addEventListener('DOMContentLoaded', async () => {
      setActionButtonsEnabled(false);

      // Connect Wallet
      document.getElementById('connect-btn').onclick = async () => {
        show('Connecting...');
        try {
          await setupWallet('metamask');
          await switchNetwork();
          await ensureCorrectNetwork();
          document.getElementById('disconnect-btn').style.display = '';
          document.getElementById('disconnect-btn').onclick = disconnectWallet;
          const address = await signer.getAddress();
          show(`Wallet connected to ${FALAJ_NETWORK.chainName}\nAddress: ${address}`);
          setActionButtonsEnabled(true);
        } catch (err) {
          show('Connection or network switch failed:\n' + (err.message || err));
          disconnectWallet();
        }
      };

      document.getElementById('add-participant-btn').onclick = async () => {
        try {
          show('Adding participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('add-account').value.trim(), 'Account address');
          const role = parseRole(document.getElementById('add-role').value.trim());
          const expiry = parseExpiry(document.getElementById('add-expiry').value.trim());
          const tx = await registry.addParticipant(account, role, expiry);
          const receipt = await tx.wait();
          show(`✅ Participant added\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Add participant failed:\n' + (err.message || err));
        }
      };

      document.getElementById('change-role-btn').onclick = async () => {
        try {
          show('Changing role...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('change-account').value.trim(), 'Account address');
          const role = parseRole(document.getElementById('change-role').value.trim());
          const tx = await registry.changeRole(account, role);
          const receipt = await tx.wait();
          show(`✅ Role changed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Change role failed:\n' + (err.message || err));
        }
      };

      document.getElementById('renew-kyc-btn').onclick = async () => {
        try {
          show('Renewing KYC...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('renew-account').value.trim(), 'Account address');
          const expiry = parseExpiry(document.getElementById('renew-expiry').value.trim());
          const tx = await registry.renewKYC(account, expiry);
          const receipt = await tx.wait();
          show(`✅ KYC renewed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Renew KYC failed:\n' + (err.message || err));
        }
      };

      document.getElementById('remove-participant-btn').onclick = async () => {
        try {
          show('Removing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('remove-account').value.trim(), 'Account address');
          const tx = await registry.removeParticipant(account);
          const receipt = await tx.wait();
          show(`✅ Participant removed\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Remove participant failed:\n' + (err.message || err));
        }
      };

      document.getElementById('freeze-btn').onclick = async () => {
        try {
          show('Freezing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const reason = requireValue(document.getElementById('freeze-reason').value.trim(), 'Reason');
          const tx = await registry.freezeAccount(account, reason);
          const receipt = await tx.wait();
          show(`✅ Participant frozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Freeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unfreeze-btn').onclick = async () => {
        try {
          show('Unfreezing participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const tx = await registry.unfreezeAccount(account);
          const receipt = await tx.wait();
          show(`✅ Participant unfrozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unfreeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('pause-btn').onclick = async () => {
        try {
          show('Pausing registry...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await registry.pause();
          const receipt = await tx.wait();
          show(`✅ Registry paused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Pause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unpause-btn').onclick = async () => {
        try {
          show('Unpausing registry...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await registry.unpause();
          const receipt = await tx.wait();
          show(`✅ Registry unpaused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unpause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('precompile-btn').onclick = async () => {
        try {
          show('Updating precompile sync...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const enabled = document.getElementById('precompile-enabled').value === 'true';
          const tx = await registry.setPrecompileSync(enabled);
          const receipt = await tx.wait();
          show(`✅ Precompile sync updated (${enabled ? 'enabled' : 'disabled'})\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Precompile sync update failed:\n' + (err.message || err));
        }
      };

      document.getElementById('lookup-btn').onclick = async () => {
        try {
          show('Fetching participant...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('lookup-account').value.trim(), 'Account address');
          const participant = await registry.getParticipant(account);
          show(
            `Participant details for ${account}\n`
            + `Whitelisted: ${participant[0]}\n`
            + `Role: ${participant[1]}\n`
            + `KYC expiry: ${participant[2]}\n`
            + `Frozen: ${participant[3]}`
          );
        } catch (err) {
          show('Lookup failed:\n' + (err.message || err));
        }
      };

      // Disconnect
      document.getElementById('disconnect-btn').onclick = disconnectWallet;
    });
  </script>
</body>
</html>
