<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Crypto Payment</title>
  <style>
    body { font-family: sans-serif; margin: auto; }
    #msg { white-space: pre-wrap; }
    #qr { margin: 20px 0; }
    #connect-btn, #pay-btn, #disconnect-btn {
      margin: 5px;
    }
    .actions {
      margin-top: 20px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-width: 780px;
    }
    .actions h4 {
      margin: 0 0 10px;
    }
    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    .action-row input {
      padding: 6px 8px;
      min-width: 180px;
    }
    .action-row button {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h3 id="prop-title"></h3>
  <p id="price-aed"></p>
  <p id="price-usd"></p>
  <button id="connect-btn">Connect Wallet</button>
  <button id="disconnect-btn" style="display:none;">Disconnect</button>
  <button id="pay-btn" disabled>Pay</button>
  <div id="qr"></div>
  <section class="actions">
    <h4>AED Stablecoin Actions</h4>
    <div class="action-row">
      <strong>Transfer</strong>
      <input id="transfer-to" placeholder="Recipient address" />
      <input id="transfer-amount" placeholder="Amount" />
      <button id="transfer-btn" disabled>Send</button>
    </div>
    <div class="action-row">
      <strong>Approve</strong>
      <input id="approve-spender" placeholder="Spender address" />
      <input id="approve-amount" placeholder="Amount" />
      <button id="approve-btn" disabled>Approve</button>
    </div>
    <div class="action-row">
      <strong>Mint (Issuer)</strong>
      <input id="mint-to" placeholder="Recipient address" />
      <input id="mint-amount" placeholder="Amount" />
      <button id="mint-btn" disabled>Mint</button>
    </div>
    <div class="action-row">
      <strong>Burn From (Issuer)</strong>
      <input id="burn-from" placeholder="From address" />
      <input id="burn-amount" placeholder="Amount" />
      <button id="burn-btn" disabled>Burn</button>
    </div>
    <div class="action-row">
      <strong>Pause Controls (Regulator)</strong>
      <button id="pause-btn" disabled>Pause</button>
      <button id="unpause-btn" disabled>Unpause</button>
    </div>
    <div class="action-row">
      <strong>Freeze (Regulator)</strong>
      <input id="freeze-account" placeholder="Account address" />
      <button id="freeze-btn" disabled>Freeze</button>
      <button id="unfreeze-btn" disabled>Unfreeze</button>
    </div>
    <div class="action-row">
      <strong>Emergency Transfer (Regulator)</strong>
      <input id="emergency-from" placeholder="From address (frozen)" />
      <input id="emergency-to" placeholder="To address" />
      <input id="emergency-amount" placeholder="Amount" />
      <button id="emergency-btn" disabled>Execute</button>
    </div>
  </section>
  <pre id="msg"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // === CONFIGURATION ===
    const FALAJ_NETWORK = {
      chainId: 75417,
      chainName: 'Falaj Testnet',
      rpcUrls: ['https://nodes-prod.18.182.4.86.sslip.io/ext/bc/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB/rpc'],
      nativeCurrency: { name: 'E-AED', symbol: 'E-AED', decimals: 18 },
      blockExplorerUrls: ['https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB']
    };

    const EXPLORER_BASE = 'https://build.avax.network/explorer/H3hnSLUCbiQaY92f34SyiUFCpfiHqm1HkGtig5BDBKKk3ZJYB';

    const DESTINATION_ADDRESS = '0x43F3f03d89290358034993aE3B3938D056D76De2';

    const AED_STABLECOIN_ADDRESS = '0xa5be895EB6DD499b688AE4bD42Fd78500cE24b0F';
    const AED_STABLECOIN_ABI = [
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "approve",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [],
        "name": "AccessControlBadConfirmation",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "neededRole",
            "type": "bytes32"
          }
        ],
        "name": "AccessControlUnauthorizedAccount",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "AccountIsFrozen",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "target",
            "type": "address"
          }
        ],
        "name": "AddressEmptyCode",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "implementation",
            "type": "address"
          }
        ],
        "name": "ERC1967InvalidImplementation",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "ERC1967NonPayable",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "allowance",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "needed",
            "type": "uint256"
          }
        ],
        "name": "ERC20InsufficientAllowance",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "sender",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "balance",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "needed",
            "type": "uint256"
          }
        ],
        "name": "ERC20InsufficientBalance",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "approver",
            "type": "address"
          }
        ],
        "name": "ERC20InvalidApprover",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "receiver",
            "type": "address"
          }
        ],
        "name": "ERC20InvalidReceiver",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "sender",
            "type": "address"
          }
        ],
        "name": "ERC20InvalidSender",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          }
        ],
        "name": "ERC20InvalidSpender",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "EnforcedPause",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "ExpectedPause",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "FailedCall",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "InvalidInitialization",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "KYCExpired",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "NotAuthorizedForUpgrade",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "NotInitializing",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "NotWhitelisted",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          }
        ],
        "name": "TransferNotAllowed",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "UUPSUnauthorizedCallContext",
        "type": "error"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "slot",
            "type": "bytes32"
          }
        ],
        "name": "UUPSUnsupportedProxiableUUID",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "ZeroAddress",
        "type": "error"
      },
      {
        "inputs": [],
        "name": "ZeroAmount",
        "type": "error"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "frozenBy",
            "type": "address"
          }
        ],
        "name": "AccountFrozen",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "unfrozenBy",
            "type": "address"
          }
        ],
        "name": "AccountUnfrozen",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "owner",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "spender",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "Approval",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "burn",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "burner",
            "type": "address"
          }
        ],
        "name": "Burn",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "burnFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "emergencyTransfer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "EmergencyWithdrawal",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "freezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "grantRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_identityRegistry",
            "type": "address"
          }
        ],
        "name": "initialize",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "uint64",
            "name": "version",
            "type": "uint64"
          }
        ],
        "name": "Initialized",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "mint",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "minter",
            "type": "address"
          }
        ],
        "name": "Mint",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "pause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "Paused",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "address",
            "name": "callerConfirmation",
            "type": "address"
          }
        ],
        "name": "renounceRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "revokeRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "indexed": true,
            "internalType": "bytes32",
            "name": "previousAdminRole",
            "type": "bytes32"
          },
          {
            "indexed": true,
            "internalType": "bytes32",
            "name": "newAdminRole",
            "type": "bytes32"
          }
        ],
        "name": "RoleAdminChanged",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "sender",
            "type": "address"
          }
        ],
        "name": "RoleGranted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "account",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "sender",
            "type": "address"
          }
        ],
        "name": "RoleRevoked",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "transfer",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "Transfer",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "transferFrom",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "unfreezeAccount",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "unpause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "Unpaused",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "implementation",
            "type": "address"
          }
        ],
        "name": "Upgraded",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "newImplementation",
            "type": "address"
          },
          {
            "internalType": "bytes",
            "name": "data",
            "type": "bytes"
          }
        ],
        "name": "upgradeToAndCall",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "owner",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          }
        ],
        "name": "allowance",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "balanceOf",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          }
        ],
        "name": "canTransfer",
        "outputs": [
          {
            "internalType": "bool",
            "name": "allowed",
            "type": "bool"
          },
          {
            "internalType": "string",
            "name": "reason",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "circulatingSupply",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "decimals",
        "outputs": [
          {
            "internalType": "uint8",
            "name": "",
            "type": "uint8"
          }
        ],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "DEFAULT_ADMIN_ROLE",
        "outputs": [
          {
            "internalType": "bytes32",
            "name": "",
            "type": "bytes32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          }
        ],
        "name": "getRoleAdmin",
        "outputs": [
          {
            "internalType": "bytes32",
            "name": "",
            "type": "bytes32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bytes32",
            "name": "role",
            "type": "bytes32"
          },
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "hasRole",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "identityRegistry",
        "outputs": [
          {
            "internalType": "contract IdentityRegistry",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "isFrozen",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "name",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "paused",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "proxiableUUID",
        "outputs": [
          {
            "internalType": "bytes32",
            "name": "",
            "type": "bytes32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "bytes4",
            "name": "interfaceId",
            "type": "bytes4"
          }
        ],
        "name": "supportsInterface",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "symbol",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalBurned",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalMinted",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "UPGRADE_INTERFACE_VERSION",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // === STATE ===
    let provider = null;
    let signer = null;
    let currentWallet = null;
    let stablecoin = null;
    let tokenDecimals = 18;
    let tokenSymbol = 'AED';

    // === UI UTILS ===
    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    function enablePayBtn(enabled) {
      document.getElementById('pay-btn').disabled = !enabled;
    }

    function setActionButtonsEnabled(enabled) {
      const actionButtons = [
        'transfer-btn',
        'approve-btn',
        'mint-btn',
        'burn-btn',
        'pause-btn',
        'unpause-btn',
        'freeze-btn',
        'unfreeze-btn',
        'emergency-btn'
      ];
      actionButtons.forEach((id) => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !enabled;
      });
    }

    function requireValue(value, label) {
      if (!value) {
        throw new Error(`${label} is required.`);
      }
      return value;
    }

    function parseTokenAmount(value) {
      const sanitized = requireValue(value, 'Amount');
      const parsed = Number(sanitized);
      if (!Number.isFinite(parsed) || parsed <= 0) {
        throw new Error('Amount must be a positive number.');
      }
      return ethers.parseUnits(String(parsed), tokenDecimals);
    }

    // === WALLET CONNECTION LOGIC ===
    async function setupWallet(kind) {
      if (kind === 'metamask' && window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        stablecoin = new ethers.Contract(AED_STABLECOIN_ADDRESS, AED_STABLECOIN_ABI, signer);
        currentWallet = 'metamask';
        return;
      }
      throw new Error('MetaMask not found');
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      currentWallet = null;
      stablecoin = null;
      enablePayBtn(false);
      setActionButtonsEnabled(false);
      document.getElementById('disconnect-btn').style.display = 'none';
      show('Wallet disconnected');
    }

    // === NETWORK SWITCHING ===
    async function switchNetwork() {
      if (!window.ethereum) {
        throw new Error('MetaMask not found');
      }
      const hex = ethers.toQuantity(FALAJ_NETWORK.chainId);
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: hex }]
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: hex, ...FALAJ_NETWORK }]
          });
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          });
        } else {
          throw err;
        }
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      stablecoin = new ethers.Contract(AED_STABLECOIN_ADDRESS, AED_STABLECOIN_ABI, signer);
    }

    async function ensureCorrectNetwork() {
      if (!provider) throw new Error('No wallet/provider connected');
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== Number(FALAJ_NETWORK.chainId)) {
        throw new Error(`Your wallet is on the wrong network. Please switch to ${FALAJ_NETWORK.chainName} (${FALAJ_NETWORK.chainId}).`);
      }
    }

    async function refreshTokenMetadata() {
      if (!stablecoin || !signer) return;
      const [decimals, symbol] = await Promise.all([
        stablecoin.decimals(),
        stablecoin.symbol()
      ]);
      tokenDecimals = Number(decimals);
      tokenSymbol = symbol;
    }

    async function getWalletBalance() {
      if (!stablecoin || !signer) return null;
      const address = await signer.getAddress();
      const balance = await stablecoin.balanceOf(address);
      return ethers.formatUnits(balance, tokenDecimals);
    }

    async function sendToken(to, amt) {
      await ensureCorrectNetwork();
      const tx = await stablecoin.transfer(to, ethers.parseUnits(String(amt), tokenDecimals));
      return tx.wait();
    }

    // === MAIN UI HANDLING ===
    document.addEventListener('DOMContentLoaded', async () => {
      // Setup UI with params
      const params = new URLSearchParams(location.search);
      document.getElementById('prop-title').textContent = params.get('title') || '';
      document.getElementById('price-aed').textContent = params.get('aed') ? `AED ${params.get('aed')}` : '';
      document.getElementById('price-usd').textContent = params.get('usd') ? `USD ${params.get('usd')}` : '';

      // Setup QR code for manual payment
      new QRCode(document.getElementById('qr'), DESTINATION_ADDRESS);
      setActionButtonsEnabled(false);

      // Connect Wallet
      document.getElementById('connect-btn').onclick = async () => {
        enablePayBtn(false);
        show('Connecting...');
        try {
          await setupWallet('metamask');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const balance = await getWalletBalance();
          document.getElementById('disconnect-btn').style.display = '';
          document.getElementById('disconnect-btn').onclick = disconnectWallet;
          show(`Wallet connected to ${FALAJ_NETWORK.chainName}\nToken: ${tokenSymbol}\nBalance: ${balance ?? '0'} ${tokenSymbol}`);
          enablePayBtn(true);
          setActionButtonsEnabled(true);
        } catch (err) {
          show('Connection or network switch failed:\n' + (err.message || err));
          disconnectWallet();
        }
      };

      // Pay
      document.getElementById('pay-btn').onclick = async () => {
        enablePayBtn(false);
        const amountParam = params.get('aed') || params.get('usd');
        const amount = Number(amountParam);
        try {
          show('Checking network...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const network = await provider.getNetwork();
          show(`Sending ${amount} ${tokenSymbol} to ${DESTINATION_ADDRESS} on chain ${network.chainId}...`);
          const receipt = await sendToken(DESTINATION_ADDRESS, amount);
          show(`✅ Sent ${amount} ${tokenSymbol} to ${DESTINATION_ADDRESS} on ${FALAJ_NETWORK.chainName}\n\nTransaction hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Payment failed:\n' + (err.message || err));
        }
        enablePayBtn(true);
      };

      document.getElementById('transfer-btn').onclick = async () => {
        try {
          show('Preparing transfer...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const to = requireValue(document.getElementById('transfer-to').value.trim(), 'Recipient address');
          const amount = parseTokenAmount(document.getElementById('transfer-amount').value.trim());
          const tx = await stablecoin.transfer(to, amount);
          const receipt = await tx.wait();
          show(`✅ Transfer complete\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Transfer failed:\n' + (err.message || err));
        }
      };

      document.getElementById('approve-btn').onclick = async () => {
        try {
          show('Preparing approval...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const spender = requireValue(document.getElementById('approve-spender').value.trim(), 'Spender address');
          const amount = parseTokenAmount(document.getElementById('approve-amount').value.trim());
          const tx = await stablecoin.approve(spender, amount);
          const receipt = await tx.wait();
          show(`✅ Approval complete\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Approval failed:\n' + (err.message || err));
        }
      };

      document.getElementById('mint-btn').onclick = async () => {
        try {
          show('Preparing mint...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const to = requireValue(document.getElementById('mint-to').value.trim(), 'Recipient address');
          const amount = parseTokenAmount(document.getElementById('mint-amount').value.trim());
          const tx = await stablecoin.mint(to, amount);
          const receipt = await tx.wait();
          show(`✅ Mint complete\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Mint failed:\n' + (err.message || err));
        }
      };

      document.getElementById('burn-btn').onclick = async () => {
        try {
          show('Preparing burn...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const from = requireValue(document.getElementById('burn-from').value.trim(), 'From address');
          const amount = parseTokenAmount(document.getElementById('burn-amount').value.trim());
          const tx = await stablecoin.burnFrom(from, amount);
          const receipt = await tx.wait();
          show(`✅ Burn complete\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Burn failed:\n' + (err.message || err));
        }
      };

      document.getElementById('pause-btn').onclick = async () => {
        try {
          show('Pausing token...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await stablecoin.pause();
          const receipt = await tx.wait();
          show(`✅ Token paused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Pause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unpause-btn').onclick = async () => {
        try {
          show('Unpausing token...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const tx = await stablecoin.unpause();
          const receipt = await tx.wait();
          show(`✅ Token unpaused\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unpause failed:\n' + (err.message || err));
        }
      };

      document.getElementById('freeze-btn').onclick = async () => {
        try {
          show('Freezing account...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const tx = await stablecoin.freezeAccount(account);
          const receipt = await tx.wait();
          show(`✅ Account frozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Freeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('unfreeze-btn').onclick = async () => {
        try {
          show('Unfreezing account...');
          await switchNetwork();
          await ensureCorrectNetwork();
          const account = requireValue(document.getElementById('freeze-account').value.trim(), 'Account address');
          const tx = await stablecoin.unfreezeAccount(account);
          const receipt = await tx.wait();
          show(`✅ Account unfrozen\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Unfreeze failed:\n' + (err.message || err));
        }
      };

      document.getElementById('emergency-btn').onclick = async () => {
        try {
          show('Preparing emergency transfer...');
          await switchNetwork();
          await ensureCorrectNetwork();
          await refreshTokenMetadata();
          const from = requireValue(document.getElementById('emergency-from').value.trim(), 'From address');
          const to = requireValue(document.getElementById('emergency-to').value.trim(), 'To address');
          const amount = parseTokenAmount(document.getElementById('emergency-amount').value.trim());
          const tx = await stablecoin.emergencyTransfer(from, to, amount);
          const receipt = await tx.wait();
          show(`✅ Emergency transfer complete\nTx hash: ${receipt.transactionHash}\nExplorer: ${EXPLORER_BASE}`);
        } catch (err) {
          show('Emergency transfer failed:\n' + (err.message || err));
        }
      };

      // Disconnect
      document.getElementById('disconnect-btn').onclick = disconnectWallet;
    });
  </script>
</body>
</html>
